"use strict";(self.webpackChunkwebxr_threejs=self.webpackChunkwebxr_threejs||[]).push([[971],{971:(e,t,n)=>{n.r(t),n.d(t,{MainScreen:()=>b,default:()=>E});var o=n(75),r=n(579),i=n(12),s=n(418);const l=document.getElementById("renderCanvas");let a=document.getElementById("loadingDiv"),c="0%",d="";var u=function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function l(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,l)}a((o=o.apply(e,t||[])).next())}))};const m={models:{}};let y=["snowScene.glb","torch.glb"];const v=new o.lLk,p=(e,t)=>u(void 0,void 0,void 0,(function*(){return new Promise((n=>{e.load(`models/${t}`,(e=>{n(e)}))}))})),g=()=>new Promise(((e,t)=>u(void 0,void 0,void 0,(function*(){v.onProgress=(e,t,n)=>{(e=>{const t=document.getElementById("progressLevel");c=e,t&&(t.style.width=c)})(`${Number(t/n*100).toFixed(0)}%`),(e=>{const t=document.getElementById("loadingText");d=e,t&&(t.innerHTML=d)})(`Loaded ${t} of ${n} files.`)},v.onError=e=>{t("There was an error loading "+e)};const n=new s.E(v).setPath("assets/");for(const e of y)try{const t=yield p(n,e);m.models[e]=t}catch(e){console.log("Error loading model: ",e),t(e)}e(m)}))));var f=n(922),h=function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function l(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,l)}a((o=o.apply(e,t||[])).next())}))};const w=e=>h(void 0,void 0,void 0,(function*(){let t=!1;(()=>{if(navigator.xr){if(/WebXRViewer\//i.test(navigator.userAgent))return;navigator.xr.addEventListener("sessiongranted",(()=>{t=!0}))}})();let n=null;const o=document.createElement("button");o.style.display="",o.style.cursor="pointer",o.style.left="calc(50% - 50px)",o.style.width="100px",o.textContent="ENTER VR";const r=()=>{o.style.display="",o.style.cursor="auto",o.style.left="0",o.style.width="100%",o.style.background="red",o.onmouseenter=null,o.onmouseleave=null,o.onclick=null},i=e=>{e.style.position="absolute",e.style.bottom="20px",e.style.padding="12px 6px",e.style.border="1px solid #fff",e.style.borderRadius="4px",e.style.background="rgba(0,0,0,0.1)",e.style.color="#fff",e.style.font="normal 13px sans-serif",e.style.textAlign="center",e.style.opacity="0.5",e.style.outline="none"};if(navigator.xr){o.id="VRButton",i(o);try{const i=yield navigator.xr.isSessionSupported("immersive-vr");i?(()=>{const t=()=>{n.removeEventListener("end",t),o.textContent="ENTER VR",n=null};o.onmouseleave=()=>{o.style.opacity="0.5"},o.onmouseenter=()=>{o.style.opacity="1.0"},o.onclick=()=>h(void 0,void 0,void 0,(function*(){if(null===n&&navigator.xr){const i={optionalFeatures:["local-floor","bounded-floor","hand-tracking","layers"]};try{r=yield navigator.xr.requestSession("immersive-vr",i),h(void 0,void 0,void 0,(function*(){r.addEventListener("end",t),yield e.xr.setSession(r),o.textContent="EXIT VR",n=r}))}catch(e){console.log(e)}}else n.end();var r}))})():(r(),o.textContent="VR NOT SUPPORTED"),i&&t&&o.click()}catch(e){s=e,r(),console.warn("Exception when trying to call xr.isSessionSupported",s),o.textContent="VR NOT ALLOWED"}return o}{const e=document.createElement("a");return!1===window.isSecureContext?(e.href=document.location.href.replace(/^http:/,"https:"),e.innerHTML="WEBXR NEEDS HTTPS"):(e.href="https://immersiveweb.dev/",e.innerHTML="WEBXR NOT AVAILABLE"),e.style.left="calc(50% - 90px)",e.style.width="180px",e.style.textDecoration="none",i(e),e}var s})),x=(e,t,n)=>{if("tracked-pointer"===e.data.targetRayMode){const e=n.models["torch.glb"].scene;e.scale.set(.2,.2,.2),t.controller.remove(...t.controller.children),t.grip.remove(...t.grip.children);const r=new o.ZAu;r.name="spotlight";const i=new o.PMe(16777215,2,12,Math.PI/15,.3);i.position.set(0,0,0),i.target.position.set(0,0,-1),r.add(i.target),r.add(i);const s=new o.fHI(.03,1,5,32,5,!0);s.rotateX(Math.PI/2);const l=((e=new o.Ilk(16777215),t=new o.Pa4,n=5,r=1.2)=>{const i=["varying vec3 vNormal;","varying vec3 vWorldPosition;","void main(){","// compute intensity","vNormal\t\t= normalize( normalMatrix * normal );","vec4 worldPosition\t= modelMatrix * vec4( position, 1.0 );","vWorldPosition\t\t= worldPosition.xyz;","// set gl_Position","gl_Position\t= projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),s=["varying vec3\t\tvNormal;","varying vec3\t\tvWorldPosition;","uniform vec3\t\tlightColor;","uniform vec3\t\tspotPosition;","uniform float\t\tattenuation;","uniform float\t\tanglePower;","void main(){","float intensity;","intensity\t= distance(vWorldPosition, spotPosition)/attenuation;","intensity\t= 1.0 - clamp(intensity, 0.0, 1.0);","vec3 normal\t= vec3(vNormal.x, vNormal.y, abs(vNormal.z));","float angleIntensity\t= pow( dot(normal, vec3(0.0, 0.0, 1.0)), anglePower );","intensity\t= intensity * angleIntensity;","gl_FragColor\t= vec4( lightColor, intensity);","}"].join("\n");return new o.jyz({uniforms:{attenuation:{value:n},anglePower:{value:r},spotPosition:{value:t},lightColor:{value:e}},vertexShader:i,fragmentShader:s,transparent:!0,depthWrite:!1})})(),a=new o.Kj0(s,l);a.translateZ(-2.6),r.add(a),r.visible=!1,t.controller.add(e),t.controller.add(r)}};class b{constructor(){this.createScene=e=>{return t=this,n=void 0,d=function*(){const t=new o.anP(e),n=new o.yGw,s=new o.iMs,d=new o.SUY,u=new o.Pa4;(new r.x).load("assets/textures/snowy_park.hdr",(e=>{const n=t.fromEquirectangular(e);m.background=n.texture,m.environment=n.texture}));const m=new o.xsS,y=new o.cPb(60,window.innerWidth/window.innerHeight,.1,100);y.position.set(0,1.6,3);const v=new o.Tme;v.add(y),m.add(v);const p=new o.Tme;y.add(p),m.add(new o.vmT(6316128,4210752));const h=new o.Ox3(16777215);h.position.set(1,1,1).normalize(),m.add(h),e.xr.enabled=!0;const b=new i.z(y,e.domElement);b.minDistance=2,b.maxDistance=10,b.target.set(0,2,0),b.update();const E=(()=>{if(a)return a;a=document.createElement("div"),a.id="loadingDiv",a.style.height="100vh",a.style.width="100%",a.style.pointerEvents="none",a.style.opacity="1",a.style.backgroundColor="black",a.style.zIndex="-1",a.style.transition="opacity 1.5s ease";const e=document.createElement("div");e.style.display="flex",e.style.alignItems="center",e.style.justifyItems="center",e.style.justifyContent="center",e.style.minHeight="100%",e.style.textAlign="center";const t=document.createElement("div"),n=document.createElement("div");n.style.color="rgba(66, 135, 245, 1)",n.style.textAlign="center";const o=document.createElement("h3");o.innerHTML="Please hang tight..",o.style.fontSize="1.125rem",o.style.lineHeight="1.5rem",o.style.fontWeight="500",n.appendChild(o);const r=document.createElement("p");r.id="loadingText",r.innerHTML="";const i=document.createElement("div");i.style.width="100%",i.style.backgroundColor="gray",i.style.borderRadius="9999px",i.style.height="0.625rem";const s=document.createElement("div");return s.style.width=c,s.style.backgroundColor="blue",s.style.height="0.625rem",s.style.borderRadius="9999px",s.id="progressLevel",i.appendChild(s),n.appendChild(i),t.appendChild(n),e.appendChild(t),n.appendChild(r),a.appendChild(e),(()=>{const e=l.getBoundingClientRect(),t=window.getComputedStyle(l).position,n=document.getElementById("loadingDiv");n&&(n.style.position="fixed"===t?"fixed":"absolute",n.style.left=e.left+"px",n.style.top=e.top+"px",n.style.width=e.width+"px",n.style.height=e.height+"px")})(),document.body.insertBefore(a,l),a})(),P=yield g(),C=P.models["snowScene.glb"];let k;m.add(C.scene);const S=yield C.parser.getDependencies("material");for(const e of S)"Snow"===e.name&&(k=e);if(k){const e=new o._12(100,100,20,20),t=new o.Kj0(e,k);t.rotation.x=-Math.PI/2,m.add(t)}const L=new o.xo$(.2,20),M=new o.vBJ({color:65280}),T=new o.Kj0(L,M);T.position.set(5,1,-8),m.add(T);const I=new o.Kj0(L,new o.vBJ({color:16777215,side:o._Li}));I.scale.set(1.2,1.2,1.2);const R=((e,t)=>{const n=new f.i,r=(new o.u9r).setFromPoints([new o.Pa4(0,0,0),new o.Pa4(0,0,-1)]),i=new o.x12(r);i.name="line",i.scale.z=0;const s=[];for(let t=0;t<=1;t++){const o=e.xr.getController(t);o.add(i.clone()),o.userData.selectPressed=!1;const r=e.xr.getControllerGrip(t),l=n.createControllerModel(r);r.add(l),s.push({controller:o,grip:r})}return s})(e);for(const e of R)e.controller.addEventListener("selectstart",(()=>{for(const t of e.controller.children)"line"===t.name&&(t.scale.z=10),"spotlight"!==t.name||t.visible||(t.visible=!0);e.controller.userData.selectPressed=!0})),e.controller.addEventListener("selectend",(()=>{for(const t of e.controller.children)"line"===t.name&&(t.scale.z=0,I.visible=!1),"spotlight"===t.name&&t.visible&&(t.visible=!1);e.controller.userData.selectPressed=!1})),e.controller.addEventListener("disconnected",(()=>{e.controller.remove(...e.controller.children)})),e.controller.addEventListener("connected",(t=>{const n=t.data.handedness;e.controller.name=`${n}Controller`,"left"===n&&x(t,e,P)})),v.add(e.controller),v.add(e.grip);const D=yield w(e);return document.body.insertBefore(D,E),(()=>{const e=document.getElementById("loadingDiv");e&&(e.style.opacity="0",e.addEventListener("transitionend",(()=>{e&&e.remove()})))})(),{scene:m,camera:y,update:()=>{const t=d.getDelta(),o=e.xr.getSession();if(o){for(const e of o.inputSources){const n=null==e?void 0:e.gamepad;if(e&&n){const n={handedness:e.handedness,buttons:e.gamepad.buttons.map((e=>e.value)),axes:e.gamepad.axes.slice(0)};if("left"===n.handedness){const e=2;let o=v.position.clone();n.axes.map(((r,i)=>{Math.abs(r)>.2&&(2===i&&(n.axes[2]>0?(v.rotation.y-=1*t,console.log("left on left thumbstick")):(v.rotation.y+=1*t,console.log("right on left thumbstick")),o=v.getWorldPosition(u)),3===i&&(n.axes[3]>0?(o.z+=1,v.translateZ(t*e),console.log("up on left thumbstick")):(o.z-=1,v.translateZ(-t*e),console.log("down on left thumbstick"))))}))}}}(()=>{const e="rightController"===R[0].controller.name?R[0]:R[1];if(e.controller&&e.controller.userData.selectPressed){n.identity().extractRotation(e.controller.matrixWorld),s.ray.origin.setFromMatrixPosition(e.controller.matrixWorld),s.ray.direction.set(0,0,-1).applyMatrix4(n);const t=s.intersectObjects([T]);t.length>0?(t[0].object.add(I),I.visible=!0):I.visible=!1}})()}}}},new((s=void 0)||(s=Promise))((function(e,o){function r(e){try{l(d.next(e))}catch(e){o(e)}}function i(e){try{l(d.throw(e))}catch(e){o(e)}}function l(t){var n;t.done?e(t.value):(n=t.value,n instanceof s?n:new s((function(e){e(n)}))).then(r,i)}l((d=d.apply(t,n||[])).next())}));var t,n,s,d}}}const E=new b}}]);
//# sourceMappingURL=971.threejsBundle.js.map